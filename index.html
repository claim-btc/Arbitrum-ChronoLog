<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <title>ChronoLog - OBSIDIAN</title>

  <script>
    window.onerror = function(msg, url, line) {
      document.body.innerHTML += '<div style="color:#ff5555; background:#111; padding:20px; position:fixed; top:0; left:0; width:100%; z-index:9999; font-family:monospace;"><h3>âš ï¸ å¯åŠ¨ä¸­æ–­</h3><p>'+msg+'</p><p>Line: '+line+'</p></div>';
    };
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['"Inter"', 'sans-serif'], mono: ['"JetBrains Mono"', 'monospace'] },
          colors: { 
            obsidian: { 900: '#050505', 800: '#0a0a0a', 700: '#121212' },
            primary: { 500: '#6366f1', 600: '#4f46e5' },
            accent: { 500: '#ec4899', 600: '#db2777' }
          },
          animation: { 'fade-up': 'fadeUp 0.8s ease-out forwards' },
          keyframes: { fadeUp: { '0%': { opacity: 0, transform: 'translateY(10px)' }, '100%': { opacity: 1, transform: 'translateY(0)' } } }
        }
      }
    }
  </script>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>

  <style>
    body { background-color: #000; color: #fff; overflow-x: hidden; }
    /* åŠ¨æ€èƒŒæ™¯ */
    .bg-mesh {
      position: fixed; inset: 0; z-index: -1;
      background: radial-gradient(circle at 15% 50%, rgba(99, 102, 241, 0.15), transparent 40%),
                  radial-gradient(circle at 85% 30%, rgba(236, 72, 153, 0.15), transparent 40%);
    }
    /* ç£¨ç ‚å¡ç‰‡ */
    .glass-card {
      background: rgba(20, 20, 20, 0.7);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }
    /* æ‰‹æœºæ—¥æœŸå®Œç¾ä¿®å¤ */
    .date-wrapper { position: relative; width: 100%; height: 100%; }
    input[type="datetime-local"] {
        position: absolute; inset: 0; opacity: 0; width: 100%; height: 100%;
        z-index: 50; cursor: pointer; color-scheme: dark;
    }
  </style>
</head>
<body>

  <div id="loading-screen" style="position:fixed; inset:0; background:#000; z-index:50; display:flex; justify-content:center; align-items:center; color:#666; font-family:monospace;">
    <div>INITIALIZING...</div>
  </div>

  <div class="bg-mesh"></div>
  <div id="root" class="relative z-10 pb-20 p-4"></div>

<script type="text/babel">

// ç§»é™¤ loading ç”»é¢
setTimeout(() => {
  const loader = document.getElementById('loading-screen');
  if(loader) loader.style.display = 'none';
}, 800);

// === é…ç½® ===
const CONTRACT_ADDRESS = "0x1A46b403A29c8cBDA564E1f4B9c6332b8873532f";
const CHAIN_ID = 421614;

// ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šABI æ ¼å¼åŒ–ï¼Œé˜²æ­¢æŠ¥é”™ ğŸ”¥
const ABI = [
  {
    "inputs": [
      { "internalType": "string", "name": "_content", "type": "string" },
      { "internalType": "uint256", "name": "_unlockTime", "type": "uint256" }
    ],
    "name": "createLog",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "getAllLogs",
    "outputs": [
      {
        "components": [
          { "internalType": "uint256", "name": "id", "type": "uint256" },
          { "internalType": "address", "name": "author", "type": "address" },
          { "internalType": "string", "name": "content", "type": "string" },
          { "internalType": "uint256", "name": "timestamp", "type": "uint256" },
          { "internalType": "uint256", "name": "unlockTime", "type": "uint256" }
        ],
        "internalType": "struct ChronoLog.Log[]",
        "name": "",
        "type": "tuple[]"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  }
];

const { useState, useEffect } = React;
const ethers = window.ethers;

// === å·¥å…· ===
function shortAddr(a) { return a ? a.slice(0,6)+"Â·Â·Â·"+a.slice(-4) : "æœªè¿æ¥"; }
function fmtDate(s) { try{const n=Number(s); return n?new Date(n*1000).toLocaleString():"-";}catch{return "-";} }
function timeAgo(ts) { const d=Date.now()/1000-Number(ts); if(d<60)return"åˆšåˆš"; if(d<3600)return Math.floor(d/60)+"åˆ†é’Ÿå‰"; return Math.floor(d/3600)+"å°æ—¶å‰"; }

// === ç¼“å­˜ ===
const CACHE_KEY = "chrono_obsidian_final";
function loadCache() { try{const r=localStorage.getItem(CACHE_KEY); const o=JSON.parse(r); return (Date.now()-o.t>60000)?null:o.d;}catch{return null;} }
function saveCache(d) { try{localStorage.setItem(CACHE_KEY, JSON.stringify({t:Date.now(), d:d}))}catch{} }

// === WalletConnect ===
async function getWCProvider() {
  const rpc={}; rpc[CHAIN_ID]="https://sepolia-rollup.arbitrum.io/rpc";
  const WCP = window.WalletConnectProvider.default || window.WalletConnectProvider;
  return new WCP({rpc:rpc, chainId:CHAIN_ID, qrcode:true});
}

function App() {
  const [provider, setProvider] = useState(null);
  const [signer, setSigner] = useState(null);
  const [account, setAccount] = useState(null);
  const [contract, setContract] = useState(null);
  const [logs, setLogs] = useState([]);
  const [loading, setLoading] = useState(false);
  const [status, setStatus] = useState(null);
  const [tab, setTab] = useState("moment");
  const [inputs, setInputs] = useState({ moment: "", capsule: "", date: "" });
  const [isRefreshing, setIsRefreshing] = useState(false);

  // åˆå§‹åŒ–åªè¯»
  useEffect(() => {
    const c = loadCache(); if(c) setLogs(c);
    if(!provider) {
      try {
        const rpc = new ethers.JsonRpcProvider("https://sepolia-rollup.arbitrum.io/rpc", {name:"ArbSepolia", chainId:CHAIN_ID});
        const cInstance = new ethers.Contract(CONTRACT_ADDRESS, ABI, rpc);
        setContract(cInstance);
        if(!c) fetchLogs(cInstance);
      } catch(e) {}
    }
  }, [provider]);

  // è‡ªåŠ¨æ¸…ç†æç¤º
  useEffect(() => { if(status){const t=setTimeout(()=>setStatus(null),5000); return ()=>clearTimeout(t)} }, [status]);

  async function fetchLogs(cInstance) {
    if(!cInstance) return;
    setIsRefreshing(true);
    try {
      const raw = await cInstance.getAllLogs();
      const fmt = raw.map(r => ({
        id: Number(r.id), author: r.author, content: r.content,
        ts: Number(r.timestamp), unlock: Number(r.unlockTime)
      })).sort((a,b) => b.id - a.id);
      setLogs(fmt); saveCache(fmt);
    } catch(e) { console.error(e); }
    finally { setIsRefreshing(false); }
  }

  async function connect(mode) {
    setStatus(null); setLoading(true);
    try {
      let p, t;
      if(mode === 'injected') {
        t = window.okxwallet || window.ethereum;
        if(!t) throw new Error("Wallet not found. Install OKX/MetaMask.");
        await t.request({method: "eth_requestAccounts"});
        p = new ethers.BrowserProvider(t, "any");
      } else {
        const wc = await getWCProvider(); await wc.enable();
        p = new ethers.BrowserProvider(wc, "any");
        wc.on("disconnect", () => window.location.reload());
      }
      const s = await p.getSigner();
      const a = await s.getAddress();
      setProvider(p); setSigner(s); setAccount(a);
      const c = new ethers.Contract(CONTRACT_ADDRESS, ABI, s);
      setContract(c);
      setStatus({type:'success', msg: "Link Established"});
      fetchLogs(c);
    } catch(e) { setStatus({type:'error', msg: e.message}); } 
    finally { setLoading(false); }
  }

  async function handleEtch() {
    if(!signer) return setStatus({type:'error', msg: "Connect Wallet"});
    const txt = tab==='moment' ? inputs.moment : inputs.capsule;
    if(!txt.trim()) return setStatus({type:'error', msg: "Content Empty"});
    
    let unlock = 0;
    if(tab === 'capsule') {
      if(!inputs.date) return setStatus({type:'error', msg: "Set Unlock Date"});
      unlock = Math.floor(new Date(inputs.date).getTime()/1000);
      if(unlock <= Date.now()/1000) return setStatus({type:'error', msg: "Future Date Only"});
    }

    try {
      setLoading(true);
      const tx = await contract.createLog(txt, BigInt(unlock));
      setStatus({type:'info', msg: "Broadcasting Tx..."});
      await tx.wait();
      setStatus({type:'success', msg: "Block Confirmed"});
      setInputs({ moment: "", capsule: "", date: "" });
      fetchLogs(contract);
    } catch(e) { setStatus({type:'error', msg: e.reason || e.message}); } 
    finally { setLoading(false); }
  }

  // === æ¸²æŸ“ ===
  return (
    <div className="font-sans text-gray-200 min-h-screen p-4 md:p-8 flex flex-col items-center">
      
      {/* é¡¶éƒ¨å¯¼èˆª */}
      <nav className="w-full max-w-5xl flex justify-between items-center mb-12 glass-card rounded-full px-6 py-3 animate-fade-up">
        <div className="flex items-center gap-3">
          <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-primary-500 to-accent-500 flex items-center justify-center font-bold text-white shadow-lg shadow-primary-500/30">C</div>
          <span className="font-bold tracking-tight text-lg">ChronoLog</span>
        </div>
        <div className="flex items-center gap-4">
          <div className="hidden md:flex items-center gap-2 text-xs font-mono text-gray-500">
            <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
            ARBITRUM SEPOLIA
          </div>
          {account ? (
            <div className="px-3 py-1.5 rounded-full bg-white/5 border border-white/10 text-xs font-mono text-gray-300">
              {shortAddr(account)}
            </div>
          ) : (
            <button onClick={()=>connect('injected')} className="text-xs font-semibold bg-white text-black px-4 py-2 rounded-full hover:bg-gray-200 transition">
              Connect
            </button>
          )}
        </div>
      </nav>

      {/* çŠ¶æ€æç¤º */}
      {status && (
        <div className={`fixed top-24 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full backdrop-blur-xl border shadow-2xl z-50 flex items-center gap-3 animate-fade-up ${status.type==='error'?'bg-red-500/10 border-red-500/20 text-red-200':'bg-green-500/10 border-green-500/20 text-green-200'}`}>
          <span className="text-sm font-medium">{status.msg}</span>
        </div>
      )}

      {/* ä¸»å†…å®¹åŒº */}
      <div className="w-full max-w-5xl grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* å·¦ä¾§ï¼šæ“ä½œå° */}
        <div className="lg:col-span-1 space-y-6 animate-fade-up" style={{animationDelay:'0.1s'}}>
          
          {/* æ ¸å¿ƒè¾“å…¥æ¡† */}
          <div className="glass-card rounded-3xl p-1 overflow-hidden">
            <div className="bg-obsidian-900/80 p-6 rounded-[22px]">
              
              {/* Tab åˆ‡æ¢ */}
              <div className="flex bg-white/5 p-1 rounded-xl mb-6">
                <button onClick={()=>setTab('moment')} className={`flex-1 py-2 text-sm font-medium rounded-lg transition-all ${tab==='moment'?'bg-primary-600 text-white shadow-lg':'text-gray-400 hover:text-white'}`}>Moment</button>
                <button onClick={()=>setTab('capsule')} className={`flex-1 py-2 text-sm font-medium rounded-lg transition-all ${tab==='capsule'?'bg-accent-600 text-white shadow-lg':'text-gray-400 hover:text-white'}`}>Capsule</button>
              </div>

              {/* è¾“å…¥åŒºåŸŸ */}
              <div className="relative group">
                <textarea 
                  value={tab==='moment'?inputs.moment:inputs.capsule}
                  onChange={(e)=>setInputs({...inputs, [tab]:e.target.value})}
                  className="w-full h-40 bg-transparent text-lg text-white placeholder-gray-600 resize-none outline-none font-light leading-relaxed"
                  placeholder={tab==='moment' ? "What's happening now?" : "Message for the future..."}
                ></textarea>
                <div className="absolute bottom-0 left-0 w-full h-px bg-gradient-to-r from-transparent via-white/20 to-transparent group-focus-within:via-primary-500 transition-all"></div>
              </div>

              {/* åº•éƒ¨æ“ä½œæ  */}
              <div className="mt-6 flex flex-col gap-4">
                {tab === 'capsule' && (
                  <div className="relative flex items-center justify-between bg-white/5 px-4 py-3 rounded-xl border border-white/5 hover:border-white/20 transition group cursor-pointer">
                    <div className="flex items-center gap-3 text-gray-400 group-hover:text-white transition pointer-events-none">
                      <span>ğŸ“…</span>
                      <span className="text-sm font-mono">{inputs.date ? new Date(inputs.date).toLocaleString() : "Set Unlock Date"}</span>
                    </div>
                    {/* æ‰‹æœºæ—¥æœŸå®Œç¾ä¿®å¤å±‚ */}
                    <div className="date-wrapper absolute inset-0">
                      <input type="datetime-local" value={inputs.date} onChange={(e)=>setInputs({...inputs, date:e.target.value})} />
                    </div>
                  </div>
                )}

                {account ? (
                  <button 
                    onClick={handleEtch} 
                    disabled={loading}
                    className="w-full py-4 rounded-xl bg-white text-black font-bold text-sm tracking-wide hover:scale-[1.02] active:scale-[0.98] transition-transform disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {loading ? "PROCESSING..." : (tab==='moment' ? "ETCH MOMENT" : "SEAL CAPSULE")}
                  </button>
                ) : (
                  <div className="grid grid-cols-2 gap-3">
                    <button onClick={()=>connect('injected')} className="py-3 rounded-xl bg-primary-600 text-white text-xs font-bold hover:bg-primary-500 transition">PC WALLET</button>
                    <button onClick={()=>connect('wc')} className="py-3 rounded-xl border border-white/20 text-white text-xs font-bold hover:bg-white/10 transition">MOBILE QR</button>
                  </div>
                )}
              </div>

            </div>
          </div>
        </div>

        {/* å³ä¾§ï¼šæ—¥å¿—æµ */}
        <div className="lg:col-span-2 space-y-6 animate-fade-up" style={{animationDelay:'0.2s'}}>
          <div className="flex items-center justify-between px-2">
            <h2 className="text-xl font-semibold tracking-tight">Timeline</h2>
            <button onClick={()=>fetchLogs(contract)} disabled={isRefreshing} className="p-2 rounded-lg hover:bg-white/5 text-gray-400 hover:text-white transition">
              <span className={`block ${isRefreshing?'animate-spin':''}`}>â†»</span>
            </button>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {logs.map((log) => {
              const isLocked = log.unlock > Date.now()/1000;
              return (
                <div key={log.id} className="glass-card rounded-2xl p-6 hover:-translate-y-1 transition-transform duration-300 group">
                  <div className="flex justify-between items-start mb-4">
                    <div className="flex items-center gap-2">
                      <div className={`px-2 py-1 text-[10px] font-bold rounded ${isLocked ? 'bg-accent-500/20 text-accent-400' : 'bg-primary-500/20 text-primary-400'}`}>
                        {isLocked ? 'LOCKED' : 'OPEN'}
                      </div>
                      <span className="text-xs font-mono text-gray-500">#{log.id}</span>
                    </div>
                    <span className="text-[10px] font-mono text-gray-600 bg-white/5 px-2 py-1 rounded">{timeAgo(log.ts)}</span>
                  </div>

                  <div className="min-h-[80px] mb-4">
                    {isLocked ? (
                      <div className="h-full flex flex-col items-center justify-center text-center p-4 border border-dashed border-white/10 rounded-xl">
                        <span className="text-xs font-mono text-accent-400 mb-1">ENCRYPTED DATA</span>
                        <span className="text-[10px] text-gray-500">Unlocks {fmtDate(log.unlock)}</span>
                      </div>
                    ) : (
                      <p className="text-sm text-gray-200 leading-relaxed font-light">{log.content}</p>
                    )}
                  </div>

                  <div className="flex items-center justify-between pt-4 border-t border-white/5">
                    <div className="flex items-center gap-2">
                      <div className="w-5 h-5 rounded-full bg-gradient-to-br from-gray-700 to-gray-900"></div>
                      <span className="text-xs font-mono text-gray-400">{shortAddr(log.author)}</span>
                    </div>
                    {isLocked && <div className="w-1.5 h-1.5 rounded-full bg-accent-500 animate-pulse"></div>}
                  </div>
                </div>
              )
            })}
            
            {logs.length === 0 && !isRefreshing && (
              <div className="col-span-full py-20 text-center">
                <p className="text-gray-500 text-sm">No data blocks found on chain.</p>
              </div>
            )}
          </div>
        </div>

      </div>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);

</script>
</body>
</html>
