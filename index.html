<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <title>Chrono Valley - Stardew Edition</title>

  <script>
    window.onerror = function(msg, url, line) {
      document.body.innerHTML += '<div style="position:fixed;top:0;left:0;width:100%;background:#3e2723;color:#ffcc80;padding:20px;z-index:9999;font-family:monospace;border-bottom:4px solid #ffcc80;"><h3>âš ï¸ RPG SYSTEM ERROR</h3><p>'+msg+'</p><p>Line: '+line+'</p></div>';
    };
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'pixel': ['"Press Start 2P"', 'cursive'],
            'hand': ['"VT323"', 'monospace'],
          },
          colors: {
            wood: {
              light: '#e69c69',
              DEFAULT: '#a05b32',
              dark: '#5d351e',
              border: '#3e2723'
            },
            paper: '#fff8e1',
            grass: '#76c442',
            sky: '#81d4fa'
          },
          animation: { 'bounce-slow': 'bounce 3s infinite' }
        }
      }
    }
  </script>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>

  <style>
    /* === æ˜Ÿéœ²è°·é£æ ¼æ ¸å¿ƒæ ·å¼ === */
    body {
      background-color: #76c442; /* è‰åœ°ç»¿ */
      background-image: 
        repeating-linear-gradient(45deg, #6ab33b 25%, transparent 25%, transparent 75%, #6ab33b 75%, #6ab33b),
        repeating-linear-gradient(45deg, #6ab33b 25%, #76c442 25%, #76c442 75%, #6ab33b 75%, #6ab33b);
      background-position: 0 0, 10px 10px;
      background-size: 20px 20px;
      font-family: "VT323", monospace;
      color: #3e2723;
      cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewport="0 0 24 24" fill="%233e2723"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 2L2 22h20L12 2zm0 4l6 14H6L12 6z"/></svg>') 12 12, auto; /* ç®€å•çš„åƒç´ å…‰æ ‡ */
    }

    /* æœ¨æ¿å¼¹çª—æ•ˆæœ */
    .rpg-panel {
      background: #e69c69;
      border: 4px solid #5d351e;
      box-shadow: 
        inset 4px 4px 0 #ffcc80,
        inset -4px -4px 0 #a05b32,
        4px 4px 0 rgba(0,0,0,0.3);
      position: relative;
    }
    /* é“†é’‰è£…é¥° */
    .rpg-panel::after {
      content: ''; position: absolute; top: 4px; left: 4px; right: 4px; bottom: 4px;
      border: 2px dashed #5d351e; pointer-events: none; opacity: 0.3;
    }

    /* åƒç´ æŒ‰é’® */
    .rpg-btn {
      background: #ffcc80;
      border: 2px solid #5d351e;
      border-bottom-width: 4px;
      color: #5d351e;
      text-transform: uppercase;
      transition: transform 0.1s;
      cursor: pointer;
      position: relative;
    }
    .rpg-btn:active {
      transform: translateY(2px);
      border-bottom-width: 2px;
    }
    .rpg-btn-primary { background: #81d4fa; } /* è“è‰²æŒ‰é’® */
    .rpg-btn-action { background: #69f0ae; }  /* ç»¿è‰²æŒ‰é’® */

    /* ç¾Šçš®çº¸è¾“å…¥æ¡† */
    .parchment {
      background: #fff8e1;
      border: 2px solid #a1887f;
      box-shadow: inset 0 0 20px rgba(161, 136, 127, 0.2);
      color: #3e2723;
    }

    /* æ‰‹æœºæ—¥æœŸä¿®å¤ (éšå½¢è¦†ç›–æ³•) */
    .pixel-date-wrapper {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    .pixel-date-input {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      opacity: 0; z-index: 10; cursor: pointer;
    }
  </style>
</head>
<body>

  <div id="root" class="min-h-screen p-4 pb-20 max-w-lg mx-auto"></div>

<script type="text/babel">

// === 1. åŒºå—é“¾é…ç½® ===
const CONTRACT_ADDRESS = "0x1A46b403A29c8cBDA564E1f4B9c6332b8873532f";
const CHAIN_ID = 421614;

// ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šABI å±•å¼€å†™ï¼Œé˜²æ­¢æŠ¥é”™ ğŸ”¥
const ABI = [
  {
    "inputs": [
      { "internalType": "string", "name": "_content", "type": "string" },
      { "internalType": "uint256", "name": "_unlockTime", "type": "uint256" }
    ],
    "name": "createLog",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "getAllLogs",
    "outputs": [
      {
        "components": [
          { "internalType": "uint256", "name": "id", "type": "uint256" },
          { "internalType": "address", "name": "author", "type": "address" },
          { "internalType": "string", "name": "content", "type": "string" },
          { "internalType": "uint256", "name": "timestamp", "type": "uint256" },
          { "internalType": "uint256", "name": "unlockTime", "type": "uint256" }
        ],
        "internalType": "struct ChronoLog.Log[]",
        "name": "",
        "type": "tuple[]"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  }
];

const { useState, useEffect } = React;
const ethers = window.ethers;

// === 2. å·¥å…·å‡½æ•° ===
function shortAddr(a) { return a ? a.slice(0,6)+".."+a.slice(-4) : "Visitor"; }
function fmtDate(s) { try{const n=Number(s); return n?new Date(n*1000).toLocaleDateString():"-";}catch{return "-";} }
function getLevel(count) { return Math.floor(Math.sqrt(count)) + 1; }

// === 3. ç¼“å­˜ ===
const CACHE_KEY = "stardew_logs_v1";
function loadCache() { try{const r=localStorage.getItem(CACHE_KEY); return r?JSON.parse(r).data:null;}catch{return null;} }
function saveCache(d) { try{localStorage.setItem(CACHE_KEY, JSON.stringify({t:Date.now(), d:d}))}catch{} }

// === 4. WalletConnect ===
async function getWCProvider() {
  const rpc={}; rpc[CHAIN_ID]="https://sepolia-rollup.arbitrum.io/rpc";
  const WCP = window.WalletConnectProvider.default || window.WalletConnectProvider;
  return new WCP({rpc:rpc, chainId:CHAIN_ID, qrcode:true});
}

function App() {
  const [provider, setProvider] = useState(null);
  const [signer, setSigner] = useState(null);
  const [account, setAccount] = useState(null);
  const [contract, setContract] = useState(null);
  const [logs, setLogs] = useState([]);
  const [loading, setLoading] = useState(false);
  const [status, setStatus] = useState(null);
  
  const [tab, setTab] = useState("moment");
  const [inputs, setInputs] = useState({ moment: "", capsule: "", date: "" });
  const [showWalletModal, setShowWalletModal] = useState(false); // æ§åˆ¶å¤šé’±åŒ…å¼¹çª—

  // åˆå§‹åŒ–
  useEffect(() => {
    const c = loadCache(); if(c) setLogs(c);
    if(!provider) {
      try {
        const rpc = new ethers.JsonRpcProvider("https://sepolia-rollup.arbitrum.io/rpc", {name:"ArbSepolia", chainId:CHAIN_ID});
        const cInstance = new ethers.Contract(CONTRACT_ADDRESS, ABI, rpc);
        setContract(cInstance);
        if(!c) fetchLogs(cInstance);
      } catch(e) {}
    }
  }, [provider]);

  // è‡ªåŠ¨æ¸…é™¤æç¤º
  useEffect(() => { if(status){const t=setTimeout(()=>setStatus(null),4000); return ()=>clearTimeout(t)} }, [status]);

  async function fetchLogs(cInstance) {
    if(!cInstance) return;
    try {
      const raw = await cInstance.getAllLogs();
      const fmt = raw.map(r => ({
        id: Number(r.id), author: r.author, content: r.content,
        ts: Number(r.timestamp), unlock: Number(r.unlockTime)
      })).sort((a,b) => b.id - a.id);
      setLogs(fmt); saveCache(fmt);
    } catch(e) { console.error(e); }
  }

  // ç»Ÿä¸€è¿æ¥å‡½æ•°
  async function connect(mode) {
    setShowWalletModal(false); // å…³é—­å¼¹çª—
    setStatus(null); setLoading(true);
    try {
      let p, t;
      if(mode === 'injected') {
        t = window.okxwallet || window.ethereum;
        if(!t) throw new Error("Wallet not found!");
        await t.request({method: "eth_requestAccounts"});
        p = new ethers.BrowserProvider(t, "any");
      } else {
        const wc = await getWCProvider(); await wc.enable();
        p = new ethers.BrowserProvider(wc, "any");
        wc.on("disconnect", () => window.location.reload());
      }
      const s = await p.getSigner();
      const a = await s.getAddress();
      setProvider(p); setSigner(s); setAccount(a);
      const c = new ethers.Contract(CONTRACT_ADDRESS, ABI, s);
      setContract(c);
      setStatus({type:'success', msg: "Welcome Back, Farmer!"});
      fetchLogs(c);
    } catch(e) { setStatus({type:'error', msg: e.message}); } 
    finally { setLoading(false); }
  }

  async function handleEtch() {
    if(!signer) return setStatus({type:'error', msg: "Connect Wallet First"});
    const txt = tab==='moment' ? inputs.moment : inputs.capsule;
    if(!txt.trim()) return setStatus({type:'error', msg: "Write something!"});
    
    let unlock = 0;
    if(tab === 'capsule') {
      if(!inputs.date) return setStatus({type:'error', msg: "Pick a date"});
      unlock = Math.floor(new Date(inputs.date).getTime()/1000);
      if(unlock <= Date.now()/1000) return setStatus({type:'error', msg: "Must be future date"});
    }

    try {
      setLoading(true);
      const tx = await contract.createLog(txt, BigInt(unlock));
      setStatus({type:'info', msg: "Planting seed..."});
      await tx.wait();
      setStatus({type:'success', msg: "Harvest Ready! (+10 XP)"});
      setInputs({ moment: "", capsule: "", date: "" });
      fetchLogs(contract);
    } catch(e) { setStatus({type:'error', msg: "Failed: " + (e.reason||e.message)}); } 
    finally { setLoading(false); }
  }

  const myCount = logs.filter(l => account && l.author.toLowerCase() === account.toLowerCase()).length;

  return (
    <div className="font-hand text-xl">
      
      {/* é¡¶éƒ¨ HUD */}
      <header className="rpg-panel p-4 mb-6 rounded-lg flex justify-between items-center">
        <div>
          <h1 className="font-pixel text-wood-dark text-lg md:text-2xl drop-shadow-sm">Chrono Valley</h1>
          <div className="text-sm text-wood-dark opacity-80">Day 1 â€¢ Spring</div>
        </div>
        <div>
          {account ? (
            <div className="flex flex-col items-end">
              <div className="font-bold text-wood-dark">{shortAddr(account)}</div>
              <div className="text-sm bg-paper px-2 border-2 border-wood-border rounded text-wood-dark">
                LVL {getLevel(myCount)}
              </div>
            </div>
          ) : (
            <button onClick={()=>setShowWalletModal(true)} className="rpg-btn rpg-btn-primary px-4 py-2 font-bold rounded shadow-md animate-bounce-slow">
              LOAD GAME
            </button>
          )}
        </div>
      </header>

      {/* çŠ¶æ€æç¤ºæ³¡ */}
      {status && (
        <div className={`mb-6 p-3 border-2 border-wood-border rounded text-center shadow-lg font-bold ${status.type==='error'?'bg-red-200 text-red-800':'bg-green-200 text-green-800'}`}>
          {status.type==='error'?'âŒ':'âœ¨'} {status.msg}
        </div>
      )}

      {/* å¤šé’±åŒ…é€‰æ‹©å¼¹çª— (æ¨¡æ‹Ÿ RainbowKit) */}
      {showWalletModal && (
        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
          <div className="rpg-panel p-6 rounded-lg w-full max-w-sm animate-bounce-slow">
            <h2 className="font-pixel text-center text-wood-dark mb-6 text-sm">SELECT WALLET</h2>
            <div className="space-y-4">
              <button onClick={()=>connect('injected')} className="w-full rpg-btn bg-white py-3 flex items-center justify-center gap-3 hover:bg-gray-100">
                <span>ğŸ¦Š</span> MetaMask / OKX
              </button>
              <button onClick={()=>connect('wc')} className="w-full rpg-btn bg-white py-3 flex items-center justify-center gap-3 hover:bg-gray-100">
                <span>ğŸ“±</span> Mobile (QR Code)
              </button>
              <button onClick={()=>setShowWalletModal(false)} className="w-full text-center text-wood-dark underline text-sm mt-2">
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}

      {/* ä¸»å·¥ä½œå° */}
      {account && (
        <main>
          <div className="rpg-panel p-2 mb-8 rounded-lg">
            <div className="bg-paper border-2 border-wood-border p-4 rounded min-h-[300px]">
              
              {/* æ ‡ç­¾é¡µ */}
              <div className="flex gap-2 mb-4 border-b-2 border-wood-light pb-2">
                <button onClick={()=>setTab('moment')} className={`flex-1 py-1 font-bold ${tab==='moment'?'text-wood-dark border-b-4 border-wood-dark':'text-gray-400'}`}>Daily Log</button>
                <button onClick={()=>setTab('capsule')} className={`flex-1 py-1 font-bold ${tab==='capsule'?'text-purple-600 border-b-4 border-purple-600':'text-gray-400'}`}>Time Capsule</button>
              </div>

              {/* è¾“å…¥åŒºåŸŸ */}
              <div className="relative">
                <textarea 
                  value={tab==='moment'?inputs.moment:inputs.capsule}
                  onChange={(e)=>setInputs({...inputs, [tab]:e.target.value})}
                  className="w-full h-32 bg-transparent outline-none resize-none text-xl leading-relaxed"
                  placeholder={tab==='moment' ? "Dear Diary, today I..." : "To my future self..."}
                  style={{fontFamily: '"VT323", monospace'}}
                ></textarea>
                
                {/* è£…é¥°æ€§ç¾½æ¯›ç¬” */}
                <div className="absolute bottom-2 right-2 text-4xl opacity-20 pointer-events-none">âœ’ï¸</div>
              </div>

              {/* èƒ¶å›Šæ—¶é—´é€‰æ‹© (ä¿®å¤ç‰ˆ) */}
              {tab === 'capsule' && (
                <div className="mt-4 pt-4 border-t-2 border-dashed border-wood-light">
                  <div className="pixel-date-wrapper rpg-btn bg-white py-2 px-4 text-center">
                    <span className="pointer-events-none text-wood-dark">
                      ğŸ“… {inputs.date ? new Date(inputs.date).toLocaleDateString() : "Pick Unlock Date"}
                    </span>
                    {/* éšå½¢åŸç”Ÿæ§ä»¶ */}
                    <input 
                      type="datetime-local" 
                      className="pixel-date-input"
                      value={inputs.date}
                      onChange={(e)=>setInputs({...inputs, date:e.target.value})}
                    />
                  </div>
                </div>
              )}

              {/* æäº¤æŒ‰é’® */}
              <div className="mt-6">
                <button 
                  disabled={loading} 
                  onClick={handleEtch} 
                  className={`w-full rpg-btn ${tab==='moment'?'rpg-btn-action':'rpg-btn-primary'} py-3 font-bold rounded shadow text-lg`}
                >
                  {loading ? "SAVING..." : (tab==='moment' ? "âœï¸ WRITE TO CHAIN" : "ğŸ”’ BURY CAPSULE")}
                </button>
              </div>
            </div>
          </div>

          {/* å…¬å‘Šæ¿ (åˆ—è¡¨) */}
          <div className="rpg-panel p-4 rounded-lg bg-[#fff3e0]">
            <h2 className="font-pixel text-wood-dark text-xs mb-4 text-center border-b-2 border-wood-dark pb-2">COMMUNITY BOARD</h2>
            
            <div className="space-y-4">
              {logs.length === 0 && <div className="text-center text-gray-500 py-8">No notes on the board yet...</div>}
              
              {logs.map(log => {
                const isLocked = log.unlock > Date.now()/1000;
                return (
                  <div key={log.id} className="bg-yellow-100 p-3 shadow border border-yellow-200 transform hover:rotate-1 transition duration-300 relative">
                    {/* é’‰å­è£…é¥° */}
                    <div className="absolute -top-3 left-1/2 -translate-x-1/2 w-4 h-4 rounded-full bg-red-800 shadow-sm border border-red-900"></div>
                    
                    <div className="flex justify-between items-center mb-2 border-b border-yellow-300 pb-1 text-sm text-wood-dark opacity-70">
                      <span>#{log.id} by {shortAddr(log.author)}</span>
                      <span>{fmtDate(log.ts)}</span>
                    </div>

                    <div className="py-2 text-lg text-wood-dark">
                      {isLocked ? (
                        <div className="flex items-center gap-2 text-purple-700 bg-purple-100 p-2 rounded">
                          <span className="text-2xl">ğŸ</span>
                          <div>
                            <div className="font-bold text-xs">DO NOT OPEN UNTIL</div>
                            <div className="font-mono">{fmtDate(log.unlock)}</div>
                          </div>
                        </div>
                      ) : log.content}
                    </div>
                  </div>
                )
              })}
            </div>
          </div>
        </main>
      )}

      <footer className="mt-12 text-center text-wood-dark opacity-60 text-sm">
        Built on Arbitrum Sepolia â€¢ Stardew Inspired
      </footer>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);

</script>
</body>
</html>
