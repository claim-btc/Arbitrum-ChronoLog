<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <title>Chrono Valley - V12 FIXED</title>

  <script>
    window.onerror = function(msg, url, line) {
      document.body.innerHTML += '<div style="position:fixed;top:0;left:0;width:100%;background:#3e2723;color:#ffcc80;padding:20px;z-index:9999;font-family:monospace;border-bottom:4px solid #ffcc80;"><h3>âš ï¸ SYSTEM ERROR</h3><p>'+msg+'</p><p>Line: '+line+'</p></div>';
    };
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 'pixel': ['"Press Start 2P"', 'cursive'], 'hand': ['"VT323"', 'monospace'] },
          colors: { wood: { light: '#e69c69', DEFAULT: '#a05b32', dark: '#5d351e', border: '#3e2723' }, paper: '#fff8e1', grass: '#76c442', sky: '#81d4fa', night: '#1a1a2e' },
          animation: { 'bounce-slow': 'bounce 3s infinite', 'rain': 'rain 0.5s linear infinite' },
          keyframes: { rain: { '0%': { transform: 'translateY(-10px)' }, '100%': { transform: 'translateY(100vh)' } } }
        }
      }
    }
  </script>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>

  <style>
    /* åŠ¨æ€èƒŒæ™¯ */
    body {
      transition: background-color 1s ease;
      font-family: "VT323", monospace;
      color: #3e2723;
      cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" style="fill:%235d351e"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 2L2 22h20L12 2zm0 4l6 14H6L12 6z"/></svg>') 12 12, auto;
    }
    .bg-day { background-color: #76c442; background-image: repeating-linear-gradient(45deg, #6ab33b 25%, transparent 25%, transparent 75%, #6ab33b 75%, #6ab33b), repeating-linear-gradient(45deg, #6ab33b 25%, #76c442 25%, #76c442 75%, #6ab33b 75%, #6ab33b); background-size: 20px 20px; }
    .bg-night { background-color: #1a1a2e; background-image: radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px); background-size: 50px 50px; color: #e0e0e0; }
    
    /* ç»„ä»¶æ ·å¼ */
    .rpg-panel { background: #e69c69; border: 4px solid #5d351e; box-shadow: inset 4px 4px 0 #ffcc80, inset -4px -4px 0 #a05b32, 4px 4px 0 rgba(0,0,0,0.3); position: relative; }
    .rpg-panel::after { content: ''; position: absolute; top: 4px; left: 4px; right: 4px; bottom: 4px; border: 2px dashed #5d351e; pointer-events: none; opacity: 0.3; }
    .rpg-btn { background: #ffcc80; border: 2px solid #5d351e; border-bottom-width: 4px; color: #5d351e; text-transform: uppercase; cursor: pointer; position: relative; }
    .rpg-btn:active { transform: translateY(2px); border-bottom-width: 2px; }
    
    /* æµ‡æ°´åŠ¨ç”» */
    .watering-can:active { transform: rotate(-45deg); transition: transform 0.2s; }
  </style>
</head>
<body class="bg-day">

  <div id="root" class="min-h-screen p-4 pb-20 max-w-lg mx-auto relative z-10"></div>

<script type="text/babel">

// === é…ç½® ===
const CONTRACT_ADDRESS = "0x1A46b403A29c8cBDA564E1f4B9c6332b8873532f";
const CHAIN_ID = 421614;

// ABI
const ABI = [
  {
    "inputs": [
      { "internalType": "string", "name": "_content", "type": "string" },
      { "internalType": "uint256", "name": "_unlockTime", "type": "uint256" }
    ],
    "name": "createLog",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "getAllLogs",
    "outputs": [
      {
        "components": [
          { "internalType": "uint256", "name": "id", "type": "uint256" },
          { "internalType": "address", "name": "author", "type": "address" },
          { "internalType": "string", "name": "content", "type": "string" },
          { "internalType": "uint256", "name": "timestamp", "type": "uint256" },
          { "internalType": "uint256", "name": "unlockTime", "type": "uint256" }
        ],
        "internalType": "struct ChronoLog.Log[]",
        "name": "",
        "type": "tuple[]"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  }
];

const { useState, useEffect, useRef } = React;
const ethers = window.ethers;

// === å·¥å…· ===
function shortAddr(a) { return a ? a.slice(0,6)+".."+a.slice(-4) : "Stranger"; }
function fmtDate(s) { try{const n=Number(s); return n?new Date(n*1000).toLocaleDateString():"-";}catch{return "-";} }

function getBadges(count, hasCapsule) {
  const b = [];
  if(count >= 1) b.push("ğŸŒ± Novice");
  if(count >= 5) b.push("ğŸšœ Pro");
  if(hasCapsule) b.push("â³ TimeLord");
  return b;
}

// ç¼“å­˜
const CACHE_KEY = "chrono_valley_v12";
function loadCache() { try{const r=localStorage.getItem(CACHE_KEY); return r?JSON.parse(r).data:null;}catch{return null;} }
function saveCache(d) { try{localStorage.setItem(CACHE_KEY, JSON.stringify({t:Date.now(), d:d}))}catch{} }

async function getWCProvider() {
  const rpc={}; rpc[CHAIN_ID]="https://sepolia-rollup.arbitrum.io/rpc";
  const WCP = window.WalletConnectProvider.default || window.WalletConnectProvider;
  return new WCP({rpc:rpc, chainId:CHAIN_ID, qrcode:true});
}

function App() {
  const [provider, setProvider] = useState(null);
  const [signer, setSigner] = useState(null);
  const [account, setAccount] = useState(null);
  const [contract, setContract] = useState(null);
  const [logs, setLogs] = useState([]);
  const [loading, setLoading] = useState(false);
  const [status, setStatus] = useState(null);
  const [tab, setTab] = useState("moment");
  const [inputs, setInputs] = useState({ moment: "", capsule: "", date: "" });
  const [showModal, setShowModal] = useState(false);
  const [weather, setWeather] = useState("Sunny");
  const [isNight, setIsNight] = useState(false);
  
  // æ—¥æœŸè¾“å…¥æ¡†å¼•ç”¨
  const dateInputRef = useRef(null);

  // åˆå§‹åŒ–
  useEffect(() => {
    const c = loadCache(); if(c) setLogs(c);
    const hour = new Date().getHours();
    const night = hour >= 18 || hour < 6;
    setIsNight(night);
    document.body.className = night ? "bg-night" : "bg-day";
    setWeather(night ? "Starry" : "Sunny");

    if(!provider) {
      const rpc = new ethers.JsonRpcProvider("https://sepolia-rollup.arbitrum.io/rpc", {name:"ArbSepolia", chainId:CHAIN_ID});
      const cInstance = new ethers.Contract(CONTRACT_ADDRESS, ABI, rpc);
      setContract(cInstance);
      if(!c) fetchLogs(cInstance);
    }
  }, [provider]);

  useEffect(() => { if(status){const t=setTimeout(()=>setStatus(null),4000); return ()=>clearTimeout(t)} }, [status]);

  async function fetchLogs(cInstance) {
    if(!cInstance) return;
    try {
      const raw = await cInstance.getAllLogs();
      const fmt = raw.map(r => ({
        id: Number(r.id), author: r.author, content: r.content,
        ts: Number(r.timestamp), unlock: Number(r.unlockTime)
      })).sort((a,b) => b.id - a.id);
      setLogs(fmt); saveCache(fmt);
    } catch(e) { console.error(e); }
  }

  async function connect(mode) {
    setShowModal(false); setStatus(null); setLoading(true);
    try {
      let p, t;
      if(mode === 'injected') {
        t = window.okxwallet || window.ethereum;
        if(!t) throw new Error("Wallet not found!");
        await t.request({method: "eth_requestAccounts"});
        p = new ethers.BrowserProvider(t, "any");
      } else {
        const wc = await getWCProvider(); await wc.enable();
        p = new ethers.BrowserProvider(wc, "any");
        wc.on("disconnect", () => window.location.reload());
      }
      const s = await p.getSigner();
      const a = await s.getAddress();
      setProvider(p); setSigner(s); setAccount(a);
      const c = new ethers.Contract(CONTRACT_ADDRESS, ABI, s);
      setContract(c);
      setStatus({type:'success', msg: "Farm Loaded!"});
      fetchLogs(c);
    } catch(e) { setStatus({type:'error', msg: e.message}); } 
    finally { setLoading(false); }
  }

  async function handleEtch() {
    if(!signer) return setStatus({type:'error', msg: "Connect Wallet"});
    const txt = tab==='moment' ? inputs.moment : inputs.capsule;
    if(!txt.trim()) return setStatus({type:'error', msg: "Empty!"});
    
    let unlock = 0;
    if(tab === 'capsule') {
      if(!inputs.date) return setStatus({type:'error', msg: "Set Date"});
      unlock = Math.floor(new Date(inputs.date).getTime()/1000);
      if(unlock <= Date.now()/1000) return setStatus({type:'error', msg: "Future only"});
    }

    try {
      setLoading(true);
      const tx = await contract.createLog(txt, BigInt(unlock));
      setStatus({type:'info', msg: "Planting..."});
      await tx.wait();
      setStatus({type:'success', msg: "Harvested!"});
      setInputs({ moment: "", capsule: "", date: "" });
      fetchLogs(contract);
    } catch(e) { setStatus({type:'error', msg: "Fail: " + (e.reason||e.message)}); } 
    finally { setLoading(false); }
  }

  async function handleWater(toAddr) {
    if(!signer) return setStatus({type:'error', msg: "Connect Wallet"});
    if(toAddr.toLowerCase() === account.toLowerCase()) return setStatus({type:'error', msg: "Can't water self!"});
    try {
      setLoading(true);
      const tx = await signer.sendTransaction({ to: toAddr, value: ethers.parseEther("0.0001") });
      setStatus({type:'info', msg: "Watering..."});
      await tx.wait();
      setStatus({type:'success', msg: "Watered! ğŸ’§"});
    } catch(e) { setStatus({type:'error', msg: "Dry tank!"}); }
    finally { setLoading(false); }
  }

  // æš´åŠ›è§¦å‘æ—¥æœŸé€‰æ‹©å™¨
  const triggerDatePicker = () => {
    if (dateInputRef.current) {
      if (dateInputRef.current.showPicker) {
        dateInputRef.current.showPicker(); // ç°ä»£æµè§ˆå™¨ API
      } else {
        dateInputRef.current.click(); // è€å¼è§¦å‘
      }
    }
  };

  const myLogs = logs.filter(l => account && l.author.toLowerCase() === account.toLowerCase());
  const badges = getBadges(myLogs.length, myLogs.some(l => l.unlock > 0));

  return (
    <div className={`font-hand text-xl ${isNight ? 'text-gray-200' : 'text-[#3e2723]'}`}>
      
      {/* HUD */}
      <header className="rpg-panel p-4 mb-6 rounded-lg flex justify-between items-center bg-[#e69c69]">
        <div>
          <h1 className="font-pixel text-lg md:text-2xl drop-shadow-sm text-[#5d351e]">Chrono Valley</h1>
          <div className="text-sm opacity-80 flex items-center gap-2">
            <span>{isNight ? 'ğŸŒ™' : 'â˜€ï¸'} {weather}</span>
            <span>â€¢ Year 1</span>
          </div>
        </div>
        <div>
          {account ? (
            <div className="flex flex-col items-end">
              <div className="font-bold">{shortAddr(account)}</div>
              <div className="flex gap-1 mt-1">
                {badges.map(b => <span key={b} className="text-xs bg-white px-1 rounded border border-[#5d351e] text-[#5d351e]">{b}</span>)}
              </div>
            </div>
          ) : (
            <button onClick={()=>setShowModal(true)} className="rpg-btn px-4 py-2 font-bold rounded shadow-md animate-bounce-slow">LOAD GAME</button>
          )}
        </div>
      </header>

      {/* çŠ¶æ€ */}
      {status && (
        <div className={`mb-6 p-3 border-2 border-[#3e2723] rounded text-center shadow-lg font-bold ${status.type==='error'?'bg-red-200 text-red-900':'bg-green-200 text-green-900'}`}>
          {status.type==='error'?'âŒ':'âœ¨'} {status.msg}
        </div>
      )}

      {/* å¼¹çª— */}
      {showModal && (
        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
          <div className="rpg-panel p-6 rounded-lg w-full max-w-sm">
            <h2 className="font-pixel text-center mb-6 text-sm text-[#5d351e]">SELECT SAVE FILE</h2>
            <div className="space-y-4">
              <button onClick={()=>connect('injected')} className="w-full rpg-btn bg-white py-3">ğŸ’» PC Wallet</button>
              <button onClick={()=>connect('wc')} className="w-full rpg-btn bg-white py-3">ğŸ“± Mobile QR</button>
              <button onClick={()=>setShowModal(false)} className="w-full text-center underline text-sm mt-2">Cancel</button>
            </div>
          </div>
        </div>
      )}

      {/* ä¸»ç•Œé¢ */}
      {account && (
        <main>
          {/* è¾“å…¥å° */}
          <div className="rpg-panel p-2 mb-8 rounded-lg">
            <div className="bg-[#fff8e1] border-2 border-[#a1887f] p-4 rounded min-h-[280px]">
              <div className="flex gap-2 mb-4 border-b-2 border-[#e69c69] pb-2">
                <button onClick={()=>setTab('moment')} className={`flex-1 py-1 font-bold ${tab==='moment'?'text-[#5d351e] border-b-4 border-[#5d351e]':'text-gray-400'}`}>Diary</button>
                <button onClick={()=>setTab('capsule')} className={`flex-1 py-1 font-bold ${tab==='capsule'?'text-purple-600 border-b-4 border-purple-600':'text-gray-400'}`}>Capsule</button>
              </div>

              <div className="relative">
                <textarea 
                  value={tab==='moment'?inputs.moment:inputs.capsule}
                  onChange={(e)=>setInputs({...inputs, [tab]:e.target.value})}
                  className="w-full h-32 bg-transparent outline-none resize-none text-xl leading-relaxed text-[#3e2723]"
                  placeholder={tab==='moment' ? "Dear Diary..." : "To future me..."}
                  style={{fontFamily: '"VT323", monospace'}}
                ></textarea>
              </div>

              {/* V12 æ—¥æœŸé€‰æ‹©ä¿®å¤: æš´åŠ›è§¦å‘ + é€æ˜å±‚è¦†ç›– */}
              {tab === 'capsule' && (
                <div className="mt-4 pt-4 border-t-2 border-dashed border-[#e69c69] relative">
                  <div 
                    onClick={triggerDatePicker} 
                    className="rpg-btn bg-white py-2 px-4 text-center relative w-full cursor-pointer hover:bg-gray-50"
                  >
                    <span className="pointer-events-none text-[#5d351e]">
                      ğŸ“… {inputs.date ? new Date(inputs.date).toLocaleDateString() : "CLICK HERE TO PICK DATE"}
                    </span>
                    
                    {/* éšå½¢ Inputï¼Œå±‚çº§æé«˜ */}
                    <input 
                      ref={dateInputRef}
                      type="datetime-local" 
                      value={inputs.date}
                      onChange={(e)=>setInputs({...inputs, date:e.target.value})}
                      style={{
                        position: 'absolute',
                        top: 0, 
                        left: 0, 
                        width: '100%', 
                        height: '100%', 
                        opacity: 0.01, /* 0.01 ç¡®ä¿æµè§ˆå™¨è®¤ä¸ºå®ƒæ˜¯å¯è§çš„ */
                        zIndex: 99999, /* æ ¸å¼¹çº§å±‚çº§ */
                        cursor: 'pointer',
                        fontSize: '16px' 
                      }}
                    />
                  </div>
                </div>
              )}

              <div className="mt-6">
                <button disabled={loading} onClick={handleEtch} className="w-full rpg-btn py-3 font-bold rounded shadow text-lg" style={{backgroundColor: tab==='moment'?'#69f0ae':'#81d4fa'}}>
                  {loading ? "SAVING..." : (tab==='moment' ? "âœï¸ WRITE" : "ğŸ”’ BURY")}
                </button>
              </div>
            </div>
          </div>

          {/* å…¬å‘Šæ¿ */}
          <div className="rpg-panel p-4 rounded-lg bg-[#fff3e0]">
            <h2 className="font-pixel text-[#5d351e] text-xs mb-4 text-center border-b-2 border-[#5d351e] pb-2">COMMUNITY BOARD</h2>
            <div className="space-y-4">
              {logs.map(log => {
                const isLocked = log.unlock > Date.now()/1000;
                return (
                  <div key={log.id} className="bg-yellow-100 p-3 shadow border border-yellow-200 relative group">
                    <div className="absolute -top-3 left-1/2 -translate-x-1/2 w-4 h-4 rounded-full bg-red-800 shadow-sm border border-red-900"></div>
                    <div className="flex justify-between items-center mb-2 border-b border-yellow-300 pb-1 text-sm opacity-70 text-[#5d351e]">
                      <span>#{log.id} â€¢ {shortAddr(log.author)}</span>
                      <span>{fmtDate(log.ts)}</span>
                    </div>
                    
                    <div className="py-2 text-lg text-[#3e2723]">
                      {isLocked ? (
                        <div className="bg-purple-100 text-purple-800 p-2 rounded text-center border border-purple-200">
                          ğŸ”’ LOCKED UNTIL {fmtDate(log.unlock)}
                        </div>
                      ) : log.content}
                    </div>

                    <div className="flex justify-end mt-2 pt-2 border-t border-yellow-200">
                      <button 
                        onClick={()=>handleWater(log.author)}
                        className="watering-can text-sm bg-blue-100 px-2 py-1 rounded border border-blue-200 hover:bg-blue-200 text-blue-800 flex items-center gap-1"
                        title="Give 0.0001 ETH"
                      >
                        ğŸš¿ Water (Tip)
                      </button>
                    </div>
                  </div>
                )
              })}
            </div>
          </div>
        </main>
      )}

      <footer className="mt-12 text-center opacity-60 text-sm pb-8">
        Built on Arbitrum â€¢ Stardew Inspired
      </footer>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);

</script>
</body>
</html>
